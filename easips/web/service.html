<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Manage service | EasIPS</title>
    <link href="./assets/bootstrap.min.css" rel="stylesheet">
    <link href="./assets/bootstrap-icons.css" rel="stylesheet">
    <style>
        .table > tbody > tr > td {
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href=".">EasIPS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle menu"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbar-content">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link btn text-light my-1" href="javascript:loadData(true)"><i class="bi bi-arrow-clockwise"></i></a></li>
                    <li class="nav-item"><span class="nav-link text-light" href="#">Refreshing in <span id="countdown">5</span>s...</span></li>
                    <li class="nav-item"><span class="nav-link" href="#">|</span></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-light" id="admin-dropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Admin</a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="admin-dropdown">
                            <li><a class="dropdown-item" href="#">Change password</a></li>
                            <li><a class="dropdown-item" href="#">Log out</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="my-4">
            <a class="btn btn-primary" href="." style="margin-top: -20px"><i class="bi bi-arrow-left me-2"></i>Back to overview</a><h1 class="d-inline ms-md-3">Manage blocked IPs</h1>
            <p class="lead">Here you can block or unblock IP addresses for the selected service</p>
        </div>
        <hr class="my-4">
        <div class="row">
            <div class="col-md-8"><h2>Blocked IP addresses</h2></div>
            <div class="col-md-4 text-end"><a class="btn btn-primary" href="javascript:addIp()"><i class="bi bi-plus-circle me-2"></i>Add IP address</a></div>
        </div>
        <table class="table table-striped table-hover" id="ipTable">
            <thead class="fw-bold">
            <tr>
                <td width="80px">#</td>
                <td>IP address</td>
                <td>Block started</td>
                <td width="150px">Actions</td>
            </tr>
            </thead>
            <tbody id="ip-pool">

            </tbody>
        </table>
    </main>

    <!--<footer class="footer bg-light mt-3">
        <div class="container py-3">
            <span class="text-muted">EasIPS, developed in 2022 by ...</span>
        </div>
    </footer>-->

    <script src="./assets/bootstrap.bundle.min.js"></script>

    <script>
	
		const ipPool = document.getElementById('ip-pool'),
              ipTable = document.getElementById('ip-table'),
			  serviceId = new URL(window.location.href).searchParams.get("id"),
              REFRESH_INTERVAL = 5; // In seconds
		console.log(serviceId);
		let ipCount = 0,
		    left4refresh = 0;
		function blockUnblock(addr, block=false) {
			console.log("// TODO: send AJAX request to " + (block ? '' : 'un') + 'block ' + addr + ' from service #' + serviceId);
		}
        function loadIp (address, block_time) {
            ipPool.innerHTML +=
                "                    <tr>\n" +
                "                        <td>" + (++ipCount) + "</td>\n" +
                "                        <td>" + address + "</td>\n" +
                "                        <td>" + block_time + "</td>\n" +
                '                        <td><a class="btn btn-primary" href="javascript:blockUnblock(\'' + address + '\')"><i class="bi bi-unlock me-2"></i>Unblock</a></td>\n' + // trash3
                "                    </tr>"
        }
        function loadData (manual=false) {
			if (manual || left4refresh <= 0) {
				ipCount = 0;
				ipPool.innerHTML = '';
				let ajaxResult = [
					['192.168.1.2', '12 minutes ago'],
					['192.168.1.58', '10 minutes ago'],
					['192.168.1.58', '20 minutes ago'],
					['192.168.1.58', '30 minutes ago'],
					['192.168.1.58', '40 minutes ago'],
					['192.168.1.5', '50 minutes ago'],
					['192.168.1.58', '20 minutes ago'],
					['192.168.1.58', '30 minutes ago'],
					['192.168.1.58', '40 minutes ago']
				],  //TODO: get the blocked IPs via AJAX
				nResults = ajaxResult.length;
				nResults = Math.floor(Math.random() * nResults); // TODO: remove
				for (let i=0; i<nResults; i++)
					loadIp(ajaxResult[i][0], ajaxResult[i][1]);
				// TODO: hide table (nResults == 0 ? ... : ...)
				// TODO: show message "No blocked IPs"
				left4refresh = REFRESH_INTERVAL;
			} else
				left4refresh--;
			countdown.innerHTML = left4refresh + "";
			if (!manual)
				setTimeout(loadData, 1000);
        }
		function addIp() {
			console.log("// TODO: show sweetalert with IP input and use blockUnblock(addr, true)");
		}
        loadData(); // TODO: get the service ID from the URL
    </script>

</body>

</html>
