<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Manage service | EasIPS</title>
    <link href="./assets/bootstrap.min.css" rel="stylesheet">
    <link href="./assets/bootstrap-icons.css" rel="stylesheet">
    <style>
        .table > tbody > tr > td {
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">EasIPS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="Toggle menu"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbar-content">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link btn text-light my-1" href="javascript:loadData(true)"><i class="bi bi-arrow-clockwise"></i></a></li>
                    <li class="nav-item"><span class="nav-link text-light" href="#">Refreshing in <span id="countdown">5</span>s...</span></li>
                    <li class="nav-item"><span class="nav-link" href="#">|</span></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-light" id="admin-dropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Admin</a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="admin-dropdown">
                            <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#pmodal">Change password</a></li>
                            <li><a class="dropdown-item" href="./logout">Log out</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="my-4">
            <a class="btn btn-primary" href="./dashboard.html" style="margin-top: -20px"><i class="bi bi-arrow-left me-2"></i>Back to overview</a><h1 class="d-inline ms-md-3">Manage blocked IPs</h1>
            <p class="lead">Here you can block or unblock IP addresses for the selected service</p>
        </div>
        <hr class="my-4">
        <div class="row">
            <div class="col-md-8"><h2>Blocked IP addresses</h2></div>
            <div class="col-md-4 text-end"><a class="btn btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#imodal"><i class="bi bi-plus-circle me-2"></i>Add IP address</a></div>
        </div>
        <table class="table table-striped table-hover" id="ipTable">
            <thead class="fw-bold">
            <tr>
                <td width="80px">#</td>
                <td>IP address</td>
                <td>Block started</td>
                <td width="150px">Actions</td>
            </tr>
            </thead>
            <tbody id="ip-pool">

            </tbody>
        </table>
		<p class="text-center my-5 text-muted d-none" id="no-results">Currently there aren't any blocked IPs for this service</p>
    </main>
	
	<div class="modal fade" id="success-modal" tabindex="-1" aria-labelledby="success-title" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="text-center my-5 d-block">
					<i class="bi bi-check2-circle h1 d-block text-success" id="success-icon"></i><span class="h3" id="success-title">Saved successfully!</span>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="pmodal" tabindex="-1" aria-labelledby="ptitle" aria-hidden="true">
		<div class="modal-dialog">
			<form class="modal-content" action="./password" method="POST" onsubmit="return changePassword(event)">
				<div class="modal-header">
					<h5 class="modal-title" id="ptitle">Change admin password</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="pold" class="form-label">Old password</label>
						<input type="password" class="form-control" id="pold" name="old" required>
					</div>
					<div class="mb-3">
						<label for="pnew" class="form-label">New password</label>
						<input type="password" class="form-control" id="pnew" name="new" required>
					</div>
					<div class="mb-3">
						<label for="prepeat" class="form-label">Repeat password</label>
						<input type="password" class="form-control" id="prepeat" name="repeat" required>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary"><span>Save</span></button>
				</div>
			</form>
		</div>
	</div>
	<div class="modal fade" id="imodal" tabindex="-1" aria-labelledby="ititle" aria-hidden="true">
		<div class="modal-dialog">
			<form class="modal-content" action="./blocked" method="POST" onsubmit="return addIp(event)">
				<div class="modal-header">
					<h5 class="modal-title" id="ititle">Manually block</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="ip" class="form-label">IP address</label>
						<input type="text" class="form-control" id="ip" name="ip" required>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary"><span>Save</span></button>
				</div>
			</form>
		</div>
	</div>

    <script src="./assets/bootstrap.bundle.min.js"></script>

    <script>
		
		let id_path = window.location.href.split('/').pop();
		const SERVICE_ID = Number.isInteger(id_path) ? id_path : new URL(window.location.href).searchParams.get("id") || '';
		
		/* SUCCESS OR ERROR MESSAGE */
		const success_modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('success-modal')),
			  success_icon = document.getElementById('success-icon'),
			  success_title = document.getElementById('success-title');
		function modalResult(error_message = null) {
			success_modal.show();
			success_title.innerHTML = error_message || 'Saved successfully!';
			if (error_message) {
				success_icon.classList.remove('bi-check2-circle');
				success_icon.classList.remove('text-danger');
				success_icon.classList.add('bi-x-circle');
				success_icon.classList.add('text-danger');
			} else {
				success_icon.classList.add('bi-check2-circle');
				success_icon.classList.add('text-success');
				success_icon.classList.remove('bi-x-circle');
				success_icon.classList.remove('text-danger');
				setTimeout(function() {
					success_modal.hide();
				}, 2500);
			}
			loadData(true);
		}
		
		/* AJAX DATA LOADING */
		const ipPool = document.getElementById('ip-pool'),
              ipTable = document.getElementById('ip-table'),
			  noResults = document.getElementById('no-results'),
			  serviceId = new URL(window.location.href).searchParams.get("id"),
              REFRESH_INTERVAL = 5; // In seconds
		console.log(serviceId);
		let ipCount = 0,
		    left4refresh = 0;
		function blockUnblock(addr, block=false) {
			console.log("// TODO: send AJAX request to " + (block ? '' : 'un') + 'block ' + addr + ' from service #' + serviceId);
			let ajax_error = "AJAX requests are<br>not implemented yet"; // Blank means no error
			modalResult(ajax_error);
		}
        function loadIp (address, block_time) {
            ipPool.innerHTML +=
                "                    <tr>\n" +
                "                        <td>" + (++ipCount) + "</td>\n" +
                "                        <td>" + address + "</td>\n" +
                "                        <td>" + block_time + "</td>\n" +
                '                        <td><a class="btn btn-primary" href="javascript:blockUnblock(\'' + address + '\')"><i class="bi bi-unlock me-2"></i>Unblock</a></td>\n' + // trash3
                "                    </tr>"
        }
        function loadData (manual=false) {
			if (manual || left4refresh == 0) {
				ipCount = 0;
				ipPool.innerHTML = '';
				let ajaxResult = [
					['192.168.1.2', '12 minutes ago'],
					['192.168.1.58', '10 minutes ago'],
					['192.168.1.58', '20 minutes ago'],
					['192.168.1.58', '30 minutes ago'],
					['192.168.1.58', '40 minutes ago'],
					['192.168.1.5', '50 minutes ago'],
					['192.168.1.58', '20 minutes ago'],
					['192.168.1.58', '30 minutes ago'],
					['192.168.1.58', '40 minutes ago']
				],  //TODO: get the blocked IPs via AJAX
				nResults = ajaxResult.length;
				nResults = Math.floor(Math.random() * nResults); // TODO: remove
				for (let i=0; i<nResults; i++)
					loadIp(ajaxResult[i][0], ajaxResult[i][1]);
				noResults.className = 'text-center my-5 text-muted d-' + (nResults == 0 ? 'block' : 'none');
				left4refresh = REFRESH_INTERVAL;
			} else
				left4refresh--;
			countdown.innerHTML = Math.max(left4refresh, 0) + "";
			if (!manual)
				setTimeout(loadData, 1000);
        }
        loadData();
		
		/* AJAX DATA UPDATING */
		const imodal = document.getElementById('imodal'),
		      pmodal = document.getElementById('pmodal');
		function addIp(e) {
			e.preventDefault();
			bootstrap.Modal.getOrCreateInstance(imodal).hide();
			blockUnblock(document.getElementById('ip').value, true);
			document.getElementById('ip').value = "";
		}
		function changePassword(e) {
			e.preventDefault();
			// TODO: send AJAX POST request
			let ajax_error = "The auth system is not<br>implemented yet"; // Blank means no error
			document.getElementById('pold').value = "";
			document.getElementById('pnew').value = "";
			document.getElementById('prepeat').value = "";
			bootstrap.Modal.getOrCreateInstance(pmodal).hide();
			modalResult(ajax_error);
		}
    </script>

</body>

</html>